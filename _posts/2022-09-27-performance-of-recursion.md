---
layout: post
title:  "재귀함수의 성능 하락"
date:   2022-09-28 00:59:00 +0900
categories: CS
comments: true
---
성능이 필요한 부분임에도 루프가 아닌 재귀로 작성하는 코드를 최근 자주 보고 있다.  
재귀호출이 내부적으로 성능을 어떻게 저하시키는지 모르거나,  
성능 하락폭이 크지 않다고 판단하는 것 같다.  

재귀 호출이 성능을 하락시키는 이유는 다음과 같다.  
1. 함수 호출 오버헤드  
2. 위에서 파생되는 캐시 미스 확률 상승

함수 호출이 일반적으로 어떻게 일어나는가에 대해 생각해보면,  
```
1. 현재 함수의 ebp(base-pointer)와 함수 종료 후 돌아올 명령어 주소 저장  
2. esp(stack-pointer)를 가감시켜 스택-프레임 확보  
3. 함수 내용 실행  
4. 저장해둔 정보로 이전 함수의 스택-프레임 복구  
```

당연히 위의 과정을 실행하는데 cpu 비용이 들고,  
여러 정보를 추가로 저장해야 하기 때문에 캐시 미스 또한 증가한다  

일반 함수이라면 인라인화 시키거나,  
재귀 함수라면 꼬리재귀 최적화로 이 문제를 해결할 수 있지만  
모든 경우에 이를 적용 가능한 게 아니다.  

꼬리재귀 최적화는 재귀호출 후 추가적인 연산이 불필요 한 경우에만 가능하고  
인라인은 과도하게 사용 시 캐시 미스를 증가시켜 오히려 성능이 하락한다.  
(2010년대 이후 캐시메모리가 발전하면서 비효율적이라는 연구를 본 적 있다.)

그러면 이 성능하락을 어떻게 해결할까?  

1. 꼬리재귀 최적화가 가능한 로직이라면 컴파일러의 최적화를 유도하여 작성한다.  
그런데 이런 경우 그냥 처음부터 루프로 작성하는것이 더 낫다고 생각한다.  

2. 재귀를 Stack으로 구현한다.  
재귀함수는 어차피 스택 메모리를 이용하여 돌아가는 것이다.  
그러면 직접 스택을 만들어 재귀호출을 대체하면 된다.  
성능 차이는 예전에 테스트해 본 거라 자료가 없는데 10배 까지도 차이가 난다.  

물론 모든 로직을 Stack으로 대체하긴 힘들 순 있으나,  
성능이 필요한 곳이라면 마다할 이유가 있는지 모르겠다.